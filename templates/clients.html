{% extends "base.html" %}

{% block title %}Clientes - Sistema de Gest√£o{% endblock %}
{% block page_title %}Gerenciamento de Clientes{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-people"></i> Lista de Clientes</h5>
        <a href="{{ url_for('add_client') }}" class="btn btn-primary">
            <i class="bi bi-person-plus"></i> Adicionar Cliente
        </a>
    </div>
    <div class="card-body">
        <!-- Search and Filter -->
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" id="searchInput" class="form-control" placeholder="üîç Buscar por nome, ID ou CPF/CNPJ...">
            </div>
            <div class="col-md-3">
                <select id="typeFilter" class="form-select">
                    <option value="">Todos os Tipos</option>
                    <option value="pessoa">Pessoa F√≠sica</option>
                    <option value="empresa">Empresa</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="vendedorFilter" class="form-select">
                    <option value="">Todos os Vendedores</option>
                    {% set vendedores = clients|map(attribute='VENDEDOR')|select|unique|list %}
                    {% for vendedor in vendedores|sort %}
                        {% if vendedor %}
                        <option value="{{ vendedor }}">{{ vendedor }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Clients Table -->
        <div class="table-responsive">
            <table class="table table-hover" id="clientsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Tipo</th>
                        <th>Vendedor</th>
                        <th>Contato</th>
                        <th>Informa√ß√µes</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in clients %}
                    <tr data-type="{{ client.TIPO|lower }}" data-vendedor="{{ client.VENDEDOR }}">
                        <td><span class="badge bg-primary">{{ client.ID_CLIENTE }}</span></td>
                        <td>
                            <strong>{{ client.CLIENTE }}</strong>
                            {% if client.CPF_CNPJ %}
                                <br><small class="text-muted">{{ client.CPF_CNPJ }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if client.TIPO|lower == 'pessoa' %}
                                <span class="badge bg-info">
                                    <i class="bi bi-person"></i> Pessoa
                                </span>
                            {% else %}
                                <span class="badge bg-success">
                                    <i class="bi bi-building"></i> Empresa
                                </span>
                            {% endif %}
                        </td>
                        <td>{{ client.VENDEDOR if client.VENDEDOR else '-' }}</td>
                        <td>
                            {% if client.TELEFONE %}
                                <i class="bi bi-telephone"></i> {{ client.TELEFONE }}<br>
                            {% endif %}
                            {% if client.ENDERECO %}
                                <small class="text-muted">
                                    <i class="bi bi-geo-alt"></i> {{ client.ENDERECO[:30] }}{% if client.ENDERECO|length > 30 %}...{% endif %}
                                </small>
                            {% endif %}
                        </td>
                        <td>
                            {% if client.TIPO|lower == 'pessoa' %}
                                {% if client.IDADE %}
                                    <small><i class="bi bi-calendar"></i> {{ client.IDADE }}</small><br>
                                {% endif %}
                                {% if client.GENERO %}
                                    <small><i class="bi bi-gender-ambiguous"></i> {{ client.GENERO }}</small><br>
                                {% endif %}
                            {% endif %}
                            {% if client.PROFISSAO %}
                                <small><i class="bi bi-briefcase"></i> {{ client.PROFISSAO }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewClient('{{ client.ID_CLIENTE }}')" title="Ver Detalhes">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="editClient('{{ client.ID_CLIENTE }}')" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteClient('{{ client.ID_CLIENTE }}')" title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="bi bi-people" style="font-size: 3rem;"></i>
                            <p>Nenhum cliente cadastrado</p>
                            <a href="{{ url_for('add_client') }}" class="btn btn-primary">Adicionar Primeiro Cliente</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Statistics -->
        {% if clients %}
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-0">{{ clients|length }}</h3>
                    <small class="text-muted">Total de Clientes</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    {% set pessoas = clients|selectattr('TIPO', 'equalto', 'Pessoa')|list|length + clients|selectattr('TIPO', 'equalto', 'pessoa')|list|length %}
                    <h3 class="mb-0">{{ pessoas }}</h3>
                    <small class="text-muted">Pessoas F√≠sicas</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    {% set empresas = clients|selectattr('TIPO', 'equalto', 'Empresa')|list|length + clients|selectattr('TIPO', 'equalto', 'empresa')|list|length %}
                    <h3 class="mb-0">{{ empresas }}</h3>
                    <small class="text-muted">Empresas</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    {% set vendedores_count = clients|map(attribute='VENDEDOR')|select|unique|list|length %}
                    <h3 class="mb-0">{{ vendedores_count }}</h3>
                    <small class="text-muted">Vendedores</small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Client Details Modal -->
<div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="clientModalBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Filtros
document.getElementById('searchInput').addEventListener('keyup', filterTable);
document.getElementById('typeFilter').addEventListener('change', filterTable);
document.getElementById('vendedorFilter').addEventListener('change', filterTable);

function filterTable() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const typeValue = document.getElementById('typeFilter').value.toLowerCase();
    const vendedorValue = document.getElementById('vendedorFilter').value;
    const rows = document.querySelectorAll('#clientsTable tbody tr');
    
    rows.forEach(row => {
        if (row.cells.length === 1 && row.querySelector('i.bi-people')) return; // linha vazia
        
        const text = row.textContent.toLowerCase();
        const type = (row.dataset.type || '').toLowerCase();
        const vendedor = row.dataset.vendedor || '';
        
        let show = true;
        if (searchValue && !text.includes(searchValue)) show = false;
        if (typeValue && type !== typeValue) show = false;
        if (vendedorValue && vendedor !== vendedorValue) show = false;
        
        row.style.display = show ? '' : 'none';
    });
}

// VER DETALHES
function viewClient(id) {
    fetch(`/api/clients/${id}`)
        .then(r => {
            if (!r.ok) throw new Error('Cliente n√£o encontrado');
            return r.json();
        })
        .then(data => {
            if (data.success) {
                const c = data.data;
                const tipoLower = (c.TIPO || '').toLowerCase();
                const isPessoa = tipoLower === 'pessoa';
                const tipoDisplay = isPessoa ? 'Pessoa F√≠sica' : 'Empresa';
                
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr><th>ID:</th><td><strong>${c.ID_CLIENTE}</strong></td></tr>
                                <tr><th>Nome:</th><td>${c.CLIENTE}</td></tr>
                                <tr><th>Tipo:</th><td>${tipoDisplay}</td></tr>
                                <tr><th>Vendedor:</th><td>${c.VENDEDOR || '-'}</td></tr>
                `;
                
                if (c.CPF_CNPJ) {
                    html += `<tr><th>${isPessoa ? 'CPF' : 'CNPJ'}:</th><td>${c.CPF_CNPJ}</td></tr>`;
                }
                if (c.TELEFONE) {
                    html += `<tr><th>Telefone:</th><td>${c.TELEFONE}</td></tr>`;
                }
                if (c.ENDERECO) {
                    html += `<tr><th>Endere√ßo:</th><td>${c.ENDERECO}</td></tr>`;
                }
                
                html += `
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                `;
                
                if (isPessoa) {
                    if (c.IDADE) html += `<tr><th>Faixa Et√°ria:</th><td>${c.IDADE}</td></tr>`;
                    if (c.GENERO) html += `<tr><th>G√™nero:</th><td>${c.GENERO}</td></tr>`;
                    if (c.PROFISSAO) html += `<tr><th>Profiss√£o:</th><td>${c.PROFISSAO}</td></tr>`;
                }
                
                html += `
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('clientModalBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('clientModal')).show();
            }
        })
        .catch(err => {
            alert('Erro ao carregar cliente: ' + err.message);
        });
}

// EDITAR
function editClient(id) {
    window.location.href = `/clients/edit/${id}`;
}

// EXCLUIR
function deleteClient(id) {
    if (!confirm(`‚ö†Ô∏è Tem certeza que deseja EXCLUIR permanentemente o cliente ${id}?\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
    }

    fetch('/api/clients/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_cliente: id })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Cliente exclu√≠do com sucesso!');
            location.reload();
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(() => alert('Erro de conex√£o'));
}
</script>
{% endblock %}