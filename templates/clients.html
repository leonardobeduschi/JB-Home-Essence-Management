{% extends "base.html" %}

{% block title %}Clientes - Sistema de Gest√£o{% endblock %}
{% block page_title %}Gerenciamento de Clientes{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-people"></i> Lista de Clientes</h5>
        <a href="{{ url_for('add_client') }}" class="btn btn-primary">
            <i class="bi bi-person-plus"></i> Adicionar Cliente
        </a>
    </div>
    <div class="card-body">
        <!-- Search and Filter -->
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" id="searchInput" class="form-control" placeholder="üîç Buscar por nome, ID ou CPF/CNPJ...">
            </div>
            <div class="col-md-3">
                <select id="typeFilter" class="form-select">
                    <option value="">Todos os Tipos</option>
                    <option value="pessoa">Pessoa F√≠sica</option>
                    <option value="empresa">Empresa</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="vendedorFilter" class="form-select">
                    <option value="">Todos os Vendedores</option>
                </select>
            </div>
        </div>

        <!-- Clients Table -->
        <div class="table-responsive" id="tableContainer" style="max-height: 600px; overflow-y: auto;">
            <table class="table table-hover" id="clientsTable">
                <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Tipo</th>
                        <th>Vendedor</th>
                        <th>Contato</th>
                        <th>Informa√ß√µes</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="clientsTableBody">
                    <!-- Loaded dynamically -->
                </tbody>
            </table>
            
            <div id="loadingIndicator" class="text-center py-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="text-muted mt-2">Carregando mais clientes...</p>
            </div>
            
            <div id="noMoreData" class="text-center py-3 text-muted" style="display: none;">
                <i class="bi bi-check-circle"></i> Todos os clientes foram carregados
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mt-4" id="statsSection" style="display: none;">
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-0" id="totalClients">0</h3>
                    <small class="text-muted">Total de Clientes</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-0" id="totalPessoas">0</h3>
                    <small class="text-muted">Pessoas F√≠sicas</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-0" id="totalEmpresas">0</h3>
                    <small class="text-muted">Empresas</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-0" id="totalVendedores">0</h3>
                    <small class="text-muted">Vendedores</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Client Details Modal -->
<div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="clientModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ===== INFINITE SCROLL STATE =====
let allClients = [];
let displayedClients = [];
let currentOffset = 0;
const BATCH_SIZE = 50;
let isLoading = false;
let hasMore = true;
let vendedores = new Set();

// ===== LOAD CLIENTS BATCH =====
async function loadClientsBatch() {
    if (isLoading || !hasMore) return;
    
    isLoading = true;
    document.getElementById('loadingIndicator').style.display = 'block';
    
    try {
        const response = await fetch(`/api/clients/paginated?offset=${currentOffset}&limit=${BATCH_SIZE}`);
        const result = await response.json();
        
        if (result.success) {
            allClients = [...allClients, ...result.data];
            hasMore = result.has_more;
            currentOffset += BATCH_SIZE;
            
            // Extract vendedores
            result.data.forEach(client => {
                if (client.VENDEDOR) vendedores.add(client.VENDEDOR);
            });
            
            updateVendedorFilter();
            filterTable();
            updateStatistics();
            
            if (!hasMore) {
                document.getElementById('noMoreData').style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Error loading clients:', error);
    } finally {
        isLoading = false;
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

// ===== UPDATE VENDEDOR FILTER =====
function updateVendedorFilter() {
    const filter = document.getElementById('vendedorFilter');
    const currentValue = filter.value;
    
    filter.innerHTML = '<option value="">Todos os Vendedores</option>';
    
    Array.from(vendedores).sort().forEach(v => {
        const option = document.createElement('option');
        option.value = v;
        option.textContent = v;
        filter.appendChild(option);
    });
    
    filter.value = currentValue;
}

// ===== RENDER CLIENTS =====
function renderClients(clients) {
    const tbody = document.getElementById('clientsTableBody');
    
    if (clients.length === 0 && currentOffset === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-5">
                    <i class="bi bi-people" style="font-size: 3rem;"></i>
                    <p>Nenhum cliente cadastrado</p>
                    <a href="${'{{ url_for("add_client") }}'}" class="btn btn-primary">Adicionar Primeiro Cliente</a>
                </td>
            </tr>
        `;
        return;
    }
    
    const html = clients.map(client => {
        const tipoLower = (client.TIPO || '').toLowerCase();
        const tipoBadge = tipoLower === 'pessoa' 
            ? '<span class="badge bg-info"><i class="bi bi-person"></i> Pessoa</span>'
            : '<span class="badge bg-success"><i class="bi bi-building"></i> Empresa</span>';
        
        return `
            <tr data-type="${tipoLower}" data-vendedor="${client.VENDEDOR || ''}">
                <td><span class="badge bg-primary">${client.ID_CLIENTE}</span></td>
                <td>
                    <strong>${client.CLIENTE}</strong>
                    ${client.CPF_CNPJ ? `<br><small class="text-muted">${client.CPF_CNPJ}</small>` : ''}
                </td>
                <td>${tipoBadge}</td>
                <td>${client.VENDEDOR || '-'}</td>
                <td>
                    ${client.TELEFONE ? `<i class="bi bi-telephone"></i> ${client.TELEFONE}<br>` : ''}
                    ${client.ENDERECO ? `<small class="text-muted"><i class="bi bi-geo-alt"></i> ${client.ENDERECO.substring(0, 30)}${client.ENDERECO.length > 30 ? '...' : ''}</small>` : ''}
                </td>
                <td>
                    ${tipoLower === 'pessoa' ? `
                        ${client.IDADE ? `<small><i class="bi bi-calendar"></i> ${client.IDADE}</small><br>` : ''}
                        ${client.GENERO ? `<small><i class="bi bi-gender-ambiguous"></i> ${client.GENERO}</small><br>` : ''}
                    ` : ''}
                    ${client.PROFISSAO ? `<small><i class="bi bi-briefcase"></i> ${client.PROFISSAO}</small>` : ''}
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewClient('${client.ID_CLIENTE}')" title="Ver Detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="editClient('${client.ID_CLIENTE}')" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteClient('${client.ID_CLIENTE}')" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    tbody.innerHTML = html;
}

// ===== FILTER TABLE =====
function filterTable() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const typeValue = document.getElementById('typeFilter').value.toLowerCase();
    const vendedorValue = document.getElementById('vendedorFilter').value;
    
    displayedClients = allClients.filter(client => {
        // Search filter
        if (searchValue) {
            const searchText = `${client.CLIENTE} ${client.ID_CLIENTE} ${client.CPF_CNPJ || ''}`.toLowerCase();
            if (!searchText.includes(searchValue)) return false;
        }
        
        // Type filter
        const clientType = (client.TIPO || '').toLowerCase();
        if (typeValue && clientType !== typeValue) return false;
        
        // Vendedor filter
        if (vendedorValue && client.VENDEDOR !== vendedorValue) return false;
        
        return true;
    });
    
    renderClients(displayedClients);
}

// ===== UPDATE STATISTICS =====
function updateStatistics() {
    if (allClients.length === 0) return;
    
    const pessoas = allClients.filter(c => (c.TIPO || '').toLowerCase() === 'pessoa').length;
    const empresas = allClients.filter(c => (c.TIPO || '').toLowerCase() === 'empresa').length;
    
    document.getElementById('totalClients').textContent = allClients.length;
    document.getElementById('totalPessoas').textContent = pessoas;
    document.getElementById('totalEmpresas').textContent = empresas;
    document.getElementById('totalVendedores').textContent = vendedores.size;
    document.getElementById('statsSection').style.display = 'flex';
}

// ===== INFINITE SCROLL =====
document.getElementById('tableContainer').addEventListener('scroll', function() {
    if (this.scrollTop + this.clientHeight >= this.scrollHeight - 100) {
        loadClientsBatch();
    }
});

// ===== FILTER LISTENERS =====
document.getElementById('searchInput').addEventListener('keyup', filterTable);
document.getElementById('typeFilter').addEventListener('change', filterTable);
document.getElementById('vendedorFilter').addEventListener('change', filterTable);

// ===== CLIENT ACTIONS =====
function viewClient(id) {
    fetch(`/api/clients/${id}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const c = data.data;
                const tipoLower = (c.TIPO || '').toLowerCase();
                const isPessoa = tipoLower === 'pessoa';
                
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr><th>ID:</th><td><strong>${c.ID_CLIENTE}</strong></td></tr>
                                <tr><th>Nome:</th><td>${c.CLIENTE}</td></tr>
                                <tr><th>Tipo:</th><td>${isPessoa ? 'Pessoa F√≠sica' : 'Empresa'}</td></tr>
                                <tr><th>Vendedor:</th><td>${c.VENDEDOR || '-'}</td></tr>
                                ${c.CPF_CNPJ ? `<tr><th>${isPessoa ? 'CPF' : 'CNPJ'}:</th><td>${c.CPF_CNPJ}</td></tr>` : ''}
                                ${c.TELEFONE ? `<tr><th>Telefone:</th><td>${c.TELEFONE}</td></tr>` : ''}
                                ${c.ENDERECO ? `<tr><th>Endere√ßo:</th><td>${c.ENDERECO}</td></tr>` : ''}
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                ${isPessoa ? `
                                    ${c.IDADE ? `<tr><th>Faixa Et√°ria:</th><td>${c.IDADE}</td></tr>` : ''}
                                    ${c.GENERO ? `<tr><th>G√™nero:</th><td>${c.GENERO}</td></tr>` : ''}
                                    ${c.PROFISSAO ? `<tr><th>Profiss√£o:</th><td>${c.PROFISSAO}</td></tr>` : ''}
                                ` : ''}
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('clientModalBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('clientModal')).show();
            }
        });
}

function editClient(id) {
    window.location.href = `/clients/edit/${id}`;
}

function deleteClient(id) {
    if (!confirm(`‚ö†Ô∏è Tem certeza que deseja EXCLUIR permanentemente o cliente ${id}?`)) return;
    
    fetch('/api/clients/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_cliente: id })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Cliente exclu√≠do com sucesso!');
            location.reload();
        } else {
            alert('Erro: ' + data.error);
        }
    });
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
    loadClientsBatch();
});
</script>
{% endblock %}