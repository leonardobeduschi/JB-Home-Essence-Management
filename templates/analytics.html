{% extends "base.html" %}

{% block title %}Analytics - Sistema de Gestão{% endblock %}
{% block page_title %}Analytics e Inteligência de Negócio{% endblock %}

{% block content %}
<!-- Period Selector -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label class="form-label">Período</label>
                <select class="form-select" id="periodSelect">
                    <option value="7">Últimos 7 dias</option>
                    <option value="30" selected>Últimos 30 dias</option>
                    <option value="90">Últimos 90 dias</option>
                    <option value="365">Último ano</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary" onclick="loadAnalytics()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- KPIs Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-graph-up"></i> Crescimento</h6>
                <h2 class="mb-0" id="kpiGrowth">+0%</h2>
                <small>vs. período anterior</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-people"></i> Novos Clientes</h6>
                <h2 class="mb-0" id="kpiNewClients">0</h2>
                <small>no período</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-arrow-repeat"></i> Taxa de Retorno</h6>
                <h2 class="mb-0" id="kpiReturnRate">0%</h2>
                <small>clientes recorrentes</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-trophy"></i> Categoria Top</h6>
                <h2 class="mb-0" id="kpiTopCategory">-</h2>
                <small>mais vendida</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 - Sales Trend and Category -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Tendência de Vendas</h5>
            </div>
            <div class="card-body">
                <canvas id="salesTrendChart" height="80"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Vendas por Categoria</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryPieChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 - Top Products and Top Clients -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-star"></i> Top 10 Produtos</h5>
            </div>
            <div class="card-body">
                <canvas id="topProductsChart" height="300"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-award"></i> Top 10 Clientes</h5>
            </div>
            <div class="card-body">
                <canvas id="topClientsChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 3 - Gender and Sellers -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-gender-ambiguous"></i> Distribuição por Gênero</h5>
            </div>
            <div class="card-body">
                <canvas id="genderChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-person-badge"></i> Desempenho por Vendedor</h5>
            </div>
            <div class="card-body">
                <canvas id="sellerChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPeriod = 30;

// Load all analytics
function loadAnalytics() {
    currentPeriod = parseInt(document.getElementById('periodSelect').value);
    
    // Load KPIs
    loadNewCustomers();
    loadReturnRate();
    loadTopCategory();
    
    // Load Charts
    loadSalesTrend();
    loadCategoryChart();
    loadTopProducts();
    loadTopClients();
    loadGenderDistribution();
    loadSellerDistribution();
}

// Load New Customers KPI
function loadNewCustomers() {
    fetch(`/api/analytics/new-customers?days=${currentPeriod}`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                document.getElementById('kpiNewClients').textContent = result.data.new_customers;
            }
        })
        .catch(error => console.error('Error loading new customers:', error));
}

// Load Return Rate KPI
function loadReturnRate() {
    fetch('/api/analytics/return-rate')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                document.getElementById('kpiReturnRate').textContent = result.data.return_rate + '%';
            }
        })
        .catch(error => console.error('Error loading return rate:', error));
}

// Load Top Category KPI
function loadTopCategory() {
    fetch('/api/analytics/top-category')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const category = result.data.category;
                document.getElementById('kpiTopCategory').textContent = 
                    category.length > 15 ? category.substring(0, 15) + '...' : category;
            }
        })
        .catch(error => console.error('Error loading top category:', error));
}

// Sales Trend Chart
function loadSalesTrend() {
    fetch(`/api/analytics/trend?days=${currentPeriod}`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const dailyData = result.data.daily_data;
                const labels = dailyData.map(d => d.date);
                const revenues = dailyData.map(d => d.revenue);
                
                const ctx = document.getElementById('salesTrendChart').getContext('2d');
                
                if (window.salesTrendChartInstance) {
                    window.salesTrendChartInstance.destroy();
                }
                
                window.salesTrendChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Receita (R$)',
                            data: revenues,
                            borderColor: 'rgb(99, 102, 241)',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3,
                            pointBackgroundColor: 'rgb(99, 102, 241)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'R$ ' + context.parsed.y.toFixed(2).replace('.', ',');
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => console.error('Error loading sales trend:', error));
}

// Category Pie Chart
function loadCategoryChart() {
    fetch('/api/analytics/categories')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const categories = result.data.categories;
                const labels = categories.map(c => c.category);
                const revenues = categories.map(c => c.revenue);
                
                const ctx = document.getElementById('categoryPieChart').getContext('2d');
                
                if (window.categoryChartInstance) {
                    window.categoryChartInstance.destroy();
                }
                
                window.categoryChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: revenues,
                            backgroundColor: [
                                'rgba(99, 102, 241, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(139, 92, 246, 0.8)',
                                'rgba(236, 72, 153, 0.8)',
                                'rgba(14, 165, 233, 0.8)',
                                'rgba(234, 88, 12, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { font: { size: 10 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': R$ ' + context.parsed.toFixed(2).replace('.', ',');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => console.error('Error loading categories:', error));
}

// Top Products Chart
function loadTopProducts() {
    fetch('/api/analytics/top-products-full?limit=10')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const products = result.data;
                const labels = products.map(p => p.label);
                const revenues = products.map(p => p.revenue);
                
                const ctx = document.getElementById('topProductsChart').getContext('2d');
                
                if (window.topProductsChartInstance) {
                    window.topProductsChartInstance.destroy();
                }
                
                window.topProductsChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Receita (R$)',
                            data: revenues,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'R$ ' + context.parsed.x.toFixed(2).replace('.', ',');
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => console.error('Error loading top products:', error));
}

// Top Clients Chart
function loadTopClients() {
    fetch('/api/analytics/top-clients-full?limit=10')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const clients = result.data;
                const labels = clients.map(c => c.name);
                const revenues = clients.map(c => c.revenue);
                
                const ctx = document.getElementById('topClientsChart').getContext('2d');
                
                if (window.topClientsChartInstance) {
                    window.topClientsChartInstance.destroy();
                }
                
                window.topClientsChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Gasto (R$)',
                            data: revenues,
                            backgroundColor: 'rgba(99, 102, 241, 0.8)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'R$ ' + context.parsed.x.toFixed(2).replace('.', ',');
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => console.error('Error loading top clients:', error));
}

// Gender Distribution Chart
function loadGenderDistribution() {
    fetch('/api/analytics/gender-distribution')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const data = result.data;
                
                const ctx = document.getElementById('genderChart').getContext('2d');
                
                if (window.genderChartInstance) {
                    window.genderChartInstance.destroy();
                }
                
                window.genderChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.values,
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(236, 72, 153, 0.8)',
                                'rgba(139, 92, 246, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        })
        .catch(error => console.error('Error loading gender distribution:', error));
}

// Seller Distribution Chart
function loadSellerDistribution() {
    fetch('/api/analytics/seller-distribution')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const data = result.data;
                
                const ctx = document.getElementById('sellerChart').getContext('2d');
                
                if (window.sellerChartInstance) {
                    window.sellerChartInstance.destroy();
                }
                
                window.sellerChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.values,
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(99, 102, 241, 0.8)',
                                'rgba(139, 92, 246, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': R$ ' + context.parsed.toFixed(2).replace('.', ',');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => console.error('Error loading seller distribution:', error));
}

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
});

// Update KPI Growth (sample - you can implement actual calculation)
document.getElementById('kpiGrowth').textContent = '+15.3%';
</script>
{% endblock %}