{% extends "base.html" %}

{% block title %}Analytics - Sistema de Gestão{% endblock %}
{% block page_title %}Analytics e Inteligência de Negócio{% endblock %}

{% block content %}
<style>
    .analytics-tab {
        cursor: pointer;
        transition: all 0.3s;
    }
    .analytics-tab:hover {
        background-color: #f0f0f0;
    }
    .analytics-tab.active {
        background-color: var(--primary-color) !important;
        color: white !important;
    }
    .analytics-section {
        display: none;
    }
    .analytics-section.active {
        display: block;
    }
    .chart-card {
        height: 100%;
        min-height: 400px;
    }
</style>

<!-- Navigation Tabs -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4 analytics-tab active rounded p-3" onclick="showSection('vendas')">
                <h5><i class="bi bi-cart-check"></i> Análise de Vendas</h5>
                <small>Visão geral, tendências e métricas</small>
            </div>
            <div class="col-md-4 analytics-tab rounded p-3" onclick="showSection('produtos')">
                <h5><i class="bi bi-box-seam"></i> Análise de Produtos</h5>
                <small>Performance, categorias e margem</small>
            </div>
            <div class="col-md-4 analytics-tab rounded p-3" onclick="showSection('clientes')">
                <h5><i class="bi bi-people"></i> Análise de Clientes</h5>
                <small>Comportamento e segmentação</small>
            </div>
        </div>
    </div>
</div>

<!-- SEÇÃO: VENDAS -->
<div id="section-vendas" class="analytics-section active">
    <!-- KPIs Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body">
                    <h6 class="mb-3"><i class="bi bi-cart-check"></i> Total Vendas</h6>
                    <h2 class="mb-0" id="kpiTotalVendas">0</h2>
                    <small>vendas realizadas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div class="card-body">
                    <h6 class="mb-3"><i class="bi bi-cash-stack"></i> Receita Total</h6>
                    <h2 class="mb-0" id="kpiReceita">R$ 0</h2>
                    <small>em vendas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <div class="card-body">
                    <h6 class="mb-3"><i class="bi bi-box-seam"></i> Itens Vendidos</h6>
                    <h2 class="mb-0" id="kpiItens">0</h2>
                    <small>unidades</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <div class="card-body">
                    <h6 class="mb-3"><i class="bi bi-graph-up"></i> Ticket Médio</h6>
                    <h2 class="mb-0" id="kpiTicket">R$ 0</h2>
                    <small>por venda</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Receita Mensal (12 meses)</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyRevenueChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-cart3"></i> Quantidade de Vendas (12 meses)</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlySalesCountChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-percent"></i> Margem Bruta vs Líquida (12 meses)</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyMarginChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-ticket"></i> Ticket Médio Mensal</h5>
                </div>
                <div class="card-body">
                    <canvas id="avgTicketChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Vendas por Meio de Pagamento</h5>
                </div>
                <div class="card-body">
                    <canvas id="paymentChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SEÇÃO: PRODUTOS -->
<div id="section-produtos" class="analytics-section">
    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-star"></i> Top 20 Produtos - Receita (Produto + Categoria)</h5>
                </div>
                <div class="card-body">
                    <canvas id="productsPerformanceChart" height="120"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-percent"></i> Top 15 - Margem Bruta (%)</h5>
                </div>
                <div class="card-body">
                    <canvas id="productGrossMarginChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-percent"></i> Top 15 - Margem Líquida (%)</h5>
                </div>
                <div class="card-body">
                    <canvas id="productNetMarginChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-tags"></i> Receita por Categoria</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoriesChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Margem Bruta por Categoria</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryMarginChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SEÇÃO: CLIENTES -->
<div id="section-clientes" class="analytics-section">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-award"></i> Top 20 Clientes - Total Gasto</h5>
                </div>
                <div class="card-body">
                    <canvas id="clientsPerformanceChart" height="120"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-gender-ambiguous"></i> Distribuição por Gênero</h5>
                </div>
                <div class="card-body">
                    <canvas id="genderChartAnalytics"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card chart-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Ticket Médio por Cliente (Top 10)</h5>
                </div>
                <div class="card-body">
                    <canvas id="clientTicketChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global chart instances
let charts = {};

// Switch between sections
function showSection(section) {
    document.querySelectorAll('.analytics-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    document.querySelectorAll('.analytics-section').forEach(sec => {
        sec.classList.remove('active');
    });
    document.getElementById('section-' + section).classList.add('active');
    
    if (section === 'vendas') loadVendasData();
    if (section === 'produtos') loadProdutosData();
    if (section === 'clientes') loadClientesData();
}

// === VENDAS ===
function loadVendasData() {
    // KPIs
    fetch('/api/analytics/sales-overview')
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                const data = result.data;
                document.getElementById('kpiTotalVendas').textContent = data.total_vendas;
                document.getElementById('kpiReceita').textContent = `R$ ${data.total_receita.toFixed(2).replace('.', ',')}`;
                document.getElementById('kpiItens').textContent = data.total_itens;
                document.getElementById('kpiTicket').textContent = `R$ ${data.ticket_medio.toFixed(2).replace('.', ',')}`;
                
                // Payment Chart
                const labels = Object.keys(data.by_payment);
                const values = Object.values(data.by_payment);
                
                if (charts.paymentChart) charts.paymentChart.destroy();
                
                const ctx = document.getElementById('paymentChart').getContext('2d');
                charts.paymentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Receita (R$)',
                            data: values,
                            backgroundColor: [
                                'rgba(99, 102, 241, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(236, 72, 153, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: v => `R$ ${v.toLocaleString('pt-BR')}` }
                            }
                        }
                    }
                });
            }
        });
    
    // Monthly Revenue
    fetch('/api/analytics/monthly-revenue')
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                if (charts.monthlyRevenue) charts.monthlyRevenue.destroy();
                
                const ctx = document.getElementById('monthlyRevenueChart').getContext('2d');
                charts.monthlyRevenue = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: result.data.months,
                        datasets: [{
                            label: 'Receita (R$)',
                            data: result.data.revenues,
                            borderColor: 'rgba(16, 185, 129, 1)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: v => `R$ ${v.toLocaleString('pt-BR')}` }
                            }
                        }
                    }
                });
            }
        });
    
    // Monthly Sales Count
    fetch('/api/analytics/monthly-sales-count')
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                if (charts.monthlySalesCount) charts.monthlySalesCount.destroy();
                
                const ctx = document.getElementById('monthlySalesCountChart').getContext('2d');
                charts.monthlySalesCount = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: result.data.months,
                        datasets: [{
                            label: 'Nº Vendas',
                            data: result.data.counts,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        });
    
    // Monthly Margin
    fetch('/api/analytics/monthly-margin')
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                if (charts.monthlyMargin) charts.monthlyMargin.destroy();
                
                const ctx = document.getElementById('monthlyMarginChart').getContext('2d');
                charts.monthlyMargin = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: result.data.months,
                        datasets: [
                            {
                                label: 'Margem Bruta (%)',
                                data: result.data.gross_margins,
                                borderColor: 'rgba(16, 185, 129, 1)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Margem Líquida (%)',
                                data: result.data.net_margins,
                                borderColor: 'rgba(245, 158, 11, 1)',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        });
    
    // Avg Ticket
    fetch('/api/analytics/avg-ticket-trend')
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                if (charts.avgTicket) charts.avgTicket.destroy();
                
                const ctx = document.getElementById('avgTicketChart').getContext('2d');
                charts.avgTicket = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: result.data.months,
                        datasets: [{
                            label: 'Ticket Médio (R$)',
                            data: result.data.tickets,
                            borderColor: 'rgba(139, 92, 246, 1)',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: v => `R$ ${v.toLocaleString('pt-BR')}` }
                            }
                        }
                    }
                });
            }
        });
}

// === PRODUTOS ===
function loadProdutosData() {
    // Products with margin
    fetch('/api/analytics/products-with-margin')
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                const products = result.data;
                const labels = products.map(p => p.label.substring(0, 30));
                const revenues = products.map(p => p.revenue);
                const grossMargins = products.slice(0, 15).map(p => p.gross_margin);
                const netMargins = products.slice(0, 15).map(p => p.net_margin);
                const marginLabels = products.slice(0, 15).map(p => p.label.substring(0, 25));
                
                // Revenue Chart
                if (charts.productsChart) charts.productsChart.destroy();
                
                const ctx1 = document.getElementById('productsPerformanceChart').getContext('2d');
                charts.productsChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Receita (R$)',
                            data: revenues,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { callback: v => `R$ ${v.toLocaleString('pt-BR')}` }
                            }
                        }
                    }
                });
                
                // Gross Margin Chart
                if (charts.grossMarginChart) charts.grossMarginChart.destroy();
                
                const ctx2 = document.getElementById('productGrossMarginChart').getContext('2d');
                charts.grossMarginChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: marginLabels,
                        datasets: [{
                            label: 'Margem Bruta (%)',
                            data: grossMargins,
                            backgroundColor: grossMargins.map(m => 
                                m > 50 ? 'rgba(16, 185, 129, 0.8)' : 
                                m > 30 ? 'rgba(245, 158, 11, 0.8)' : 
                                'rgba(239, 68, 68, 0.8)'
                            )
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
                
                // Net Margin Chart
                if (charts.netMarginChart) charts.netMarginChart.destroy();
                
                const ctx3 = document.getElementById('productNetMarginChart').getContext('2d');
                charts.netMarginChart = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: marginLabels,
                        datasets: [{
                            label: 'Margem Líquida (%)',
                            data: netMargins,
                            backgroundColor: netMargins.map(m => 
                                m > 40 ? 'rgba(16, 185, 129, 0.8)' : 
                                m > 20 ? 'rgba(245, 158, 11, 0.8)' : 
                                'rgba(239, 68, 68, 0.8)'
                            )
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }
        });
    
    // Categories
    fetch('/api/analytics/categories')
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                const cats = result.data.categories;
                const labels = cats.map(c => c.category);
                const revenues = cats.map(c => c.revenue);
                
                if (charts.categoriesChart) charts.categoriesChart.destroy();
                
                const ctx = document.getElementById('categoriesChart').getContext('2d');
                charts.categoriesChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: revenues,
                            backgroundColor: [
                                'rgba(99, 102, 241, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(236, 72, 153, 0.8)',
                                'rgba(139, 92, 246, 0.8)',
                                'rgba(59, 130, 246, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
        });
    
    // Category Margin
    fetch('/api/analytics/category-margin')
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                const cats = result.data;
                const labels = cats.map(c => c.category);
                const margins = cats.map(c => c.gross_margin);
                
                if (charts.categoryMarginChart) charts.categoryMarginChart.destroy();
                
                const ctx = document.getElementById('categoryMarginChart').getContext('2d');
                charts.categoryMarginChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Margem Bruta (%)',
                            data: margins,
                            backgroundColor: 'rgba(99, 102, 241, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        });
}

// === CLIENTES ===
function loadClientesData() {
    fetch('/api/analytics/clients-performance')
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                const clients = result.data;
                const labels = clients.map(c => c.cliente.substring(0, 20));
                const revenues = clients.map(c => c.total_gasto);
                const tickets = clients.map(c => c.ticket_medio);
                
                if (charts.clientsChart) charts.clientsChart.destroy();
                
                const ctx = document.getElementById('clientsPerformanceChart').getContext('2d');
                charts.clientsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Gasto (R$)',
                            data: revenues,
                            backgroundColor: 'rgba(99, 102, 241, 0.8)'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { callback: v => `R$ ${v.toLocaleString('pt-BR')}` }
                            }
                        }
                    }
                });
                
                // Ticket Chart
                if (charts.ticketChart) charts.ticketChart.destroy();
                
                const ctx2 = document.getElementById('clientTicketChart').getContext('2d');
                charts.ticketChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: labels.slice(0, 10),
                        datasets: [{
                            label: 'Ticket Médio (R$)',
                            data: tickets.slice(0, 10),
                            backgroundColor: 'rgba(245, 158, 11, 0.8)'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }
        });
    
    // Gender
    fetch('/api/analytics/gender-distribution')
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                if (charts.genderChart) charts.genderChart.destroy();
                
                const ctx = document.getElementById('genderChartAnalytics').getContext('2d');
                charts.genderChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: result.data.labels,
                        datasets: [{
                            data: result.data.values,
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(236, 72, 153, 0.8)',
                                'rgba(139, 92, 246, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
        });
}

// Initial load
document.addEventListener('DOMContentLoaded', () => loadVendasData());
</script>
{% endblock %}