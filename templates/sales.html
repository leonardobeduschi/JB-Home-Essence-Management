{% extends "base.html" %}

{% block title %}Vendas - Sistema de Gest√£o{% endblock %}
{% block page_title %}Hist√≥rico de Vendas{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-cart-check"></i> Vendas Registradas</h5>
        <a href="{{ url_for('add_sale') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Nova Venda
        </a>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-3">
                <input type="text" id="searchInput" class="form-control" placeholder="üîç Buscar...">
            </div>
            <div class="col-md-2">
                <select id="paymentFilter" class="form-select">
                    <option value="">Todos os Pagamentos</option>
                    <option value="dinheiro">Dinheiro</option>
                    <option value="pix">PIX</option>
                    <option value="cart√£o de cr√©dito">Cart√£o de Cr√©dito</option>
                    <option value="cart√£o de d√©bito">Cart√£o de D√©bito</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="categoryFilter" class="form-select">
                    <option value="">Todas Categorias</option>
                </select>
            </div>
            <div class="col-md-2">
                <input type="date" id="dateFromFilter" class="form-control" placeholder="Data inicial">
            </div>
            <div class="col-md-2">
                <input type="date" id="dateToFilter" class="form-control" placeholder="Data final">
            </div>
            <div class="col-md-1">
                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()" title="Limpar Filtros">
                    <i class="bi bi-x-circle"></i>
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body py-2">
                        <small>Total de Itens</small>
                        <h4 class="mb-0" id="totalSalesDisplay">...</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body py-2">
                        <small>Receita Total</small>
                        <h4 class="mb-0" id="totalRevenueDisplay">R$ ...</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body py-2">
                        <small>Itens Vendidos</small>
                        <h4 class="mb-0" id="totalItemsDisplay">...</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body py-2">
                        <small>Vendas √önicas</small>
                        <h4 class="mb-0" id="uniqueSalesDisplay">...</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Table -->
        <div class="table-responsive" id="tableContainer" style="max-height: 600px; overflow-y: auto;">
            <table class="table table-hover table-sm" id="salesTable">
                <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                    <tr>
                        <th>ID</th>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Produto</th>
                        <th>Categoria</th>
                        <th>Qtd</th>
                        <th>Pre√ßo Unit.</th>
                        <th>Total Item</th>
                        <th>Pagamento</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody">
                    <!-- Loaded dynamically -->
                </tbody>
            </table>
            
            <div id="loadingIndicator" class="text-center py-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="text-muted mt-2">Carregando mais vendas...</p>
            </div>
            
            <div id="noMoreData" class="text-center py-3 text-muted" style="display: none;">
                <i class="bi bi-check-circle"></i> Todas as vendas foram carregadas
            </div>
        </div>
    </div>
</div>

<!-- Sale Details Modal -->
<div class="modal fade" id="saleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Venda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="saleModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ===== INFINITE SCROLL STATE =====
let allSales = [];
let displayedSales = [];
let currentOffset = 0;
const BATCH_SIZE = 50;
let isLoading = false;
let hasMore = true;
let categories = new Set();

// ===== LOAD SALES BATCH =====
async function loadSalesBatch() {
    if (isLoading || !hasMore) return;
    
    isLoading = true;
    document.getElementById('loadingIndicator').style.display = 'block';
    
    try {
        const response = await fetch(`/api/sales/paginated?offset=${currentOffset}&limit=${BATCH_SIZE}`);
        const result = await response.json();
        
        if (result.success) {
            allSales = [...allSales, ...result.data];
            hasMore = result.has_more;
            currentOffset += BATCH_SIZE;
            
            // Extract categories
            result.data.forEach(sale => {
                if (sale.CATEGORIA) categories.add(sale.CATEGORIA);
            });
            
            updateCategoryFilter();
            filterTable();
            
            if (!hasMore) {
                document.getElementById('noMoreData').style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Error loading sales:', error);
    } finally {
        isLoading = false;
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

// ===== UPDATE CATEGORY FILTER =====
function updateCategoryFilter() {
    const filter = document.getElementById('categoryFilter');
    const currentValue = filter.value;
    
    // Keep first option
    filter.innerHTML = '<option value="">Todas Categorias</option>';
    
    Array.from(categories).sort().forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        filter.appendChild(option);
    });
    
    filter.value = currentValue;
}

// ===== RENDER SALES =====
function renderSales(sales) {
    const tbody = document.getElementById('salesTableBody');
    
    if (sales.length === 0 && currentOffset === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center text-muted py-5">
                    <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
                    <p>Nenhuma venda registrada</p>
                    <a href="${'{{ url_for("add_sale") }}'}" class="btn btn-primary">Registrar Primeira Venda</a>
                </td>
            </tr>
        `;
        return;
    }
    
    const html = sales.map(sale => `
        <tr data-payment="${sale.MEIO}" data-category="${sale.CATEGORIA}" data-date="${sale.DATA}" data-sale-id="${sale.ID_VENDA}">
            <td><span class="badge bg-secondary">${sale.ID_VENDA}</span></td>
            <td>${sale.DATA}</td>
            <td>
                <strong>${sale.CLIENTE}</strong><br>
                <small class="text-muted">${sale.ID_CLIENTE}</small>
            </td>
            <td>
                ${sale.PRODUTO}<br>
                <small class="text-muted">${sale.CODIGO}</small>
            </td>
            <td><span class="badge bg-info">${sale.CATEGORIA}</span></td>
            <td><strong>${sale.QUANTIDADE}</strong></td>
            <td>R$ ${formatCurrencyBR(sale.PRECO_UNIT)}</td>
            <td><strong class="text-success">R$ ${formatCurrencyBR(sale.PRECO_TOTAL)}</strong></td>
            <td>${getPaymentBadge(sale.MEIO)}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewSaleDetails('${sale.ID_VENDA}')">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteSale('${sale.ID_VENDA}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

function getPaymentBadge(meio) {
    const badges = {
        'dinheiro': '<span class="badge bg-success"><i class="bi bi-cash"></i> Dinheiro</span>',
        'pix': '<span class="badge bg-primary"><i class="bi bi-phone"></i> PIX</span>',
        'cart√£o de cr√©dito': '<span class="badge bg-info"><i class="bi bi-credit-card"></i> Cr√©dito</span>',
        'cart√£o de d√©bito': '<span class="badge bg-warning text-dark"><i class="bi bi-credit-card-2-front"></i> D√©bito</span>'
    };
    return badges[meio.toLowerCase()] || `<span class="badge bg-secondary">${meio}</span>`;
}

// ===== FILTER TABLE =====
function filterTable() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const paymentValue = document.getElementById('paymentFilter').value.toLowerCase();
    const categoryValue = document.getElementById('categoryFilter').value;
    const dateFrom = document.getElementById('dateFromFilter').value;
    const dateTo = document.getElementById('dateToFilter').value;
    
    displayedSales = allSales.filter(sale => {
        // Search filter
        if (searchValue) {
            const searchText = `${sale.CLIENTE} ${sale.PRODUTO} ${sale.CODIGO} ${sale.ID_VENDA}`.toLowerCase();
            if (!searchText.includes(searchValue)) return false;
        }
        
        // Payment filter
        if (paymentValue && sale.MEIO.toLowerCase() !== paymentValue) return false;
        
        // Category filter
        if (categoryValue && sale.CATEGORIA !== categoryValue) return false;
        
        // Date filters
        if (dateFrom || dateTo) {
            const saleDate = parseDate(sale.DATA);
            if (dateFrom && saleDate < new Date(dateFrom)) return false;
            if (dateTo && saleDate > new Date(dateTo)) return false;
        }
        
        return true;
    });
    
    renderSales(displayedSales);
    updateFilteredSummary();
}

function parseDate(dateStr) {
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    return new Date(dateStr);
}

// ===== UPDATE SUMMARY =====
function updateFilteredSummary() {
    const visibleCount = displayedSales.length;
    const visibleItems = displayedSales.reduce((sum, s) => sum + s.QUANTIDADE, 0);
    const visibleSaleIds = new Set(displayedSales.map(s => s.ID_VENDA));
    
    document.getElementById('totalSalesDisplay').textContent = visibleCount;
    document.getElementById('totalItemsDisplay').textContent = visibleItems;
    document.getElementById('uniqueSalesDisplay').textContent = visibleSaleIds.size;
}

function loadSalesSummary() {
    fetch('/api/sales/summary')
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                const data = result.data;
                document.getElementById('totalRevenueDisplay').textContent = 'R$ ' + formatCurrencyBR(data.total_revenue);
            }
        });
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('paymentFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('dateFromFilter').value = '';
    document.getElementById('dateToFilter').value = '';
    filterTable();
}

// ===== INFINITE SCROLL =====
document.getElementById('tableContainer').addEventListener('scroll', function() {
    if (this.scrollTop + this.clientHeight >= this.scrollHeight - 100) {
        loadSalesBatch();
    }
});

// ===== FILTER LISTENERS =====
document.getElementById('searchInput').addEventListener('keyup', filterTable);
document.getElementById('paymentFilter').addEventListener('change', filterTable);
document.getElementById('categoryFilter').addEventListener('change', filterTable);
document.getElementById('dateFromFilter').addEventListener('change', filterTable);
document.getElementById('dateToFilter').addEventListener('change', filterTable);

// ===== SALE ACTIONS =====
function viewSaleDetails(id) {
    fetch(`/api/sales/group/${id}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const items = data.data;
                const total = parseFloat(items[0].VALOR_TOTAL_VENDA || 0);
                
                let html = `
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="bi bi-receipt"></i> Venda ${id}</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr><th>Data:</th><td>${items[0].DATA}</td></tr>
                                <tr><th>Cliente:</th><td><strong>${items[0].CLIENTE}</strong> (${items[0].ID_CLIENTE})</td></tr>
                                <tr><th>Pagamento:</th><td><strong>${items[0].MEIO.toUpperCase()}</strong></td></tr>
                            </table>
                            
                            <h6 class="mt-3">Itens da Venda:</h6>
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Categoria</th>
                                        <th>Qtd</th>
                                        <th>Pre√ßo Unit.</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                items.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.PRODUTO}<br><small class="text-muted">${item.CODIGO}</small></td>
                            <td><span class="badge bg-info">${item.CATEGORIA}</span></td>
                            <td><strong>${item.QUANTIDADE}</strong></td>
                            <td>R$ ${formatCurrencyBR(parseFloat(item.PRECO_UNIT))}</td>
                            <td><strong>R$ ${formatCurrencyBR(parseFloat(item.PRECO_TOTAL))}</strong></td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                                <tfoot>
                                    <tr class="table-success">
                                        <th colspan="4" class="text-end">TOTAL DA VENDA:</th>
                                        <th><h5 class="mb-0">R$ ${formatCurrencyBR(total)}</h5></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('saleModalBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('saleModal')).show();
            }
        });
}

function deleteSale(id) {
    if (!confirm(`‚ö†Ô∏è Tem certeza que deseja EXCLUIR permanentemente a venda ${id}?`)) return;
    
    fetch('/api/sales/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_venda: id })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Venda exclu√≠da com sucesso!');
            location.reload();
        } else {
            alert('Erro: ' + data.error);
        }
    });
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
    loadSalesSummary();
    loadSalesBatch();
});
</script>
{% endblock %}