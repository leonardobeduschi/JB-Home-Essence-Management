{% extends "base.html" %}

{% block title %}Vendas - Sistema de Gest√£o{% endblock %}
{% block page_title %}Hist√≥rico de Vendas{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-cart-check"></i> Vendas Registradas</h5>
        <a href="{{ url_for('add_sale') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Nova Venda
        </a>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-3">
                <input type="text" id="searchInput" class="form-control" placeholder="üîç Buscar...">
            </div>
            <div class="col-md-2">
                <select id="paymentFilter" class="form-select">
                    <option value="">Todos os Pagamentos</option>
                    {% set payment_methods = sales|map(attribute='MEIO')|unique|list %}
                    {% for method in payment_methods|sort %}
                        <option value="{{ method }}">{{ method|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select id="categoryFilter" class="form-select">
                    <option value="">Todas Categorias</option>
                    {% set categories = sales|map(attribute='CATEGORIA')|unique|list %}
                    {% for category in categories|sort %}
                        <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <input type="date" id="dateFromFilter" class="form-control" placeholder="Data inicial">
            </div>
            <div class="col-md-2">
                <input type="date" id="dateToFilter" class="form-control" placeholder="Data final">
            </div>
            <div class="col-md-1">
                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()" title="Limpar Filtros">
                    <i class="bi bi-x-circle"></i>
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        {% if sales %}
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body py-2">
                        <small>Total de Itens</small>
                        <h4 class="mb-0" id="totalSales">{{ sales|length }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body py-2">
                        <small>Receita Total</small>
                        <h4 class="mb-0" id="totalRevenue">
                        R$
                        {{
                            "{:,.2f}".format(sales|sum(attribute='PRECO_TOTAL'))
                            |replace(',', 'X')
                            |replace('.', ',')
                            |replace('X', '.')
                        }}
                        </h4>

                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body py-2">
                        <small>Itens Vendidos</small>
                        <h4 class="mb-0" id="totalItems">{{ sales|sum(attribute='QUANTIDADE') }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body py-2">
                        <small>Vendas √önicas</small>
                        <h4 class="mb-0" id="uniqueSales">{{ sales|map(attribute='ID_VENDA')|unique|list|length }}</h4>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Sales Table -->
        <div class="table-responsive">
            <table class="table table-hover table-sm" id="salesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Produto</th>
                        <th>Categoria</th>
                        <th>Qtd</th>
                        <th>Pre√ßo Unit.</th>
                        <th>Total Item</th>
                        <th>Pagamento</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales|reverse %}
                    <tr data-payment="{{ sale.MEIO }}" data-category="{{ sale.CATEGORIA }}" data-date="{{ sale.DATA }}">
                        <td><span class="badge bg-secondary">{{ sale.ID_VENDA }}</span></td>
                        <td>{{ sale.DATA }}</td>
                        <td>
                            <strong>{{ sale.CLIENTE }}</strong><br>
                            <small class="text-muted">{{ sale.ID_CLIENTE }}</small>
                        </td>
                        <td>
                            {{ sale.PRODUTO }}<br>
                            <small class="text-muted">{{ sale.CODIGO }}</small>
                        </td>
                        <td><span class="badge bg-info">{{ sale.CATEGORIA }}</span></td>
                        <td><strong>{{ sale.QUANTIDADE }}</strong></td>
                        <td>R$ {{ "%.2f"|format(sale.PRECO_UNIT) }}</td>
                        <td><strong class="text-success">R$ {{ "%.2f"|format(sale.PRECO_TOTAL) }}</strong></td>
                        <td>
                            {% if sale.MEIO == 'dinheiro' %}
                                <span class="badge bg-success"><i class="bi bi-cash"></i> Dinheiro</span>
                            {% elif sale.MEIO == 'pix' %}
                                <span class="badge bg-primary"><i class="bi bi-phone"></i> PIX</span>
                            {% elif sale.MEIO == 'cartao_credito' %}
                                <span class="badge bg-info"><i class="bi bi-credit-card"></i> Cr√©dito</span>
                            {% elif sale.MEIO == 'cartao_debito' %}
                                <span class="badge bg-warning text-dark"><i class="bi bi-credit-card-2-front"></i> D√©bito</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ sale.MEIO }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" title="Ver detalhes" onclick="viewSaleDetails('{{ sale.ID_VENDA }}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-danger" title="Excluir venda" onclick="deleteSale('{{ sale.ID_VENDA }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center text-muted">
                            <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
                            <p>Nenhuma venda registrada</p>
                            <a href="{{ url_for('add_sale') }}" class="btn btn-primary">Registrar Primeira Venda</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Sale Details Modal -->
<div class="modal fade" id="saleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Venda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="saleModalBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSaleId = null;

// Filter functionality
document.getElementById('searchInput').addEventListener('keyup', filterTable);
document.getElementById('paymentFilter').addEventListener('change', filterTable);
document.getElementById('categoryFilter').addEventListener('change', filterTable);
document.getElementById('dateFromFilter').addEventListener('change', filterTable);
document.getElementById('dateToFilter').addEventListener('change', filterTable);

function filterTable() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const paymentValue = document.getElementById('paymentFilter').value;
    const categoryValue = document.getElementById('categoryFilter').value;
    const dateFrom = document.getElementById('dateFromFilter').value;
    const dateTo = document.getElementById('dateToFilter').value;
    
    const rows = document.querySelectorAll('#salesTable tbody tr');
    let visibleCount = 0;
    let visibleRevenue = 0;
    let visibleItems = 0;
    
    rows.forEach(row => {
        if (row.cells.length === 1) return; // Skip empty state
        
        const text = row.textContent.toLowerCase();
        const payment = row.getAttribute('data-payment');
        const category = row.getAttribute('data-category');
        const date = row.getAttribute('data-date');
        
        let showRow = true;
        
        // Search filter
        if (searchValue && !text.includes(searchValue)) {
            showRow = false;
        }
        
        // Payment filter
        if (paymentValue && payment !== paymentValue) {
            showRow = false;
        }
        
        // Category filter
        if (categoryValue && category !== categoryValue) {
            showRow = false;
        }
        
        // Date filters
        if (dateFrom || dateTo) {
            const saleDate = parseDate(date);
            if (dateFrom && saleDate < new Date(dateFrom)) showRow = false;
            if (dateTo && saleDate > new Date(dateTo)) showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
        
        // Update summary
        if (showRow) {
            visibleCount++;
            const total = parseFloat(row.cells[7].textContent.replace('R$ ', '').replace(',', '.'));
            const qty = parseInt(row.cells[5].textContent);
            visibleRevenue += total;
            visibleItems += qty;
        }
    });
    
    // Update summary cards
    document.getElementById('totalSales').textContent = visibleCount;
    document.getElementById('totalRevenue').textContent = 'R$ ' + visibleRevenue.toFixed(2).replace('.', ',');
    document.getElementById('totalItems').textContent = visibleItems;
}

function parseDate(dateStr) {
    // Assumes DD/MM/YYYY format
    const parts = dateStr.split('/');
    return new Date(parts[2], parts[1] - 1, parts[0]);
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('paymentFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('dateFromFilter').value = '';
    document.getElementById('dateToFilter').value = '';
    filterTable();
}

function viewSaleDetails(id) {
    // Get ALL items from this sale
    fetch(`/api/sales/group/${id}`)
        .then(r => {
            if (!r.ok) throw new Error('Venda n√£o encontrada');
            return r.json();
        })
        .then(data => {
            if (data.success) {
                const items = data.data;
                
                if (items.length === 0) {
                    alert('Nenhum item encontrado para esta venda.');
                    return;
                }
                
                // Calculate total
                const total = items.reduce((sum, item) => sum + parseFloat(item.PRECO_TOTAL), 0);
                
                let html = `
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="bi bi-receipt"></i> Venda ${id}</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr><th>Data:</th><td>${items[0].DATA}</td></tr>
                                <tr><th>Cliente:</th><td><strong>${items[0].CLIENTE}</strong> (${items[0].ID_CLIENTE})</td></tr>
                                <tr><th>Pagamento:</th><td><strong>${items[0].MEIO.toUpperCase()}</strong></td></tr>
                            </table>
                            
                            <h6 class="mt-3">Itens da Venda:</h6>
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Categoria</th>
                                        <th>Qtd</th>
                                        <th>Pre√ßo Unit.</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                items.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.PRODUTO}<br><small class="text-muted">${item.CODIGO}</small></td>
                            <td><span class="badge bg-info">${item.CATEGORIA}</span></td>
                            <td><strong>${item.QUANTIDADE}</strong></td>
                            <td>R$ ${parseFloat(item.PRECO_UNIT).toFixed(2)}</td>
                            <td><strong>R$ ${parseFloat(item.PRECO_TOTAL).toFixed(2)}</strong></td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                                <tfoot>
                                    <tr class="table-success">
                                        <th colspan="4" class="text-end">TOTAL DA VENDA:</th>
                                        <th><h5 class="mb-0">R$ ${total.toFixed(2)}</h5></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('saleModalBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('saleModal')).show();
            }
        })
        .catch(err => {
            alert('Erro ao carregar detalhes da venda: ' + err.message);
        });
}

function deleteSale(id) {
    if (!confirm(`‚ö†Ô∏è Tem certeza que deseja EXCLUIR permanentemente a venda ${id}?\nO estoque ser√° restaurado automaticamente!\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
    }

    fetch('/api/sales/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_venda: id })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Venda exclu√≠da com sucesso!');
            location.reload();
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(() => alert('Erro de conex√£o'));
}
</script>
{% endblock %}